<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ShutApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; font-family:system-ui; background:#0f0f14; color:#fff; }
    #app { padding:12px; }
    .post { background:#1a1a22; border-radius:14px; padding:12px; margin-bottom:12px; }
    .text { white-space:pre-wrap; line-height:1.4; font-size:15px; }
    .reactions { display:flex; gap:14px; margin-top:10px; }
    .reaction { background:transparent; border:0; color:#fff; font-size:20px; cursor:pointer; opacity:.9; }
    .reaction span { font-size:12px; opacity:.7; margin-left:4px; }
    .more { width:100%; background:#2a2a38; color:#fff; border:0; border-radius:10px; padding:10px; }
    .hint { opacity:.7; padding:12px; }
  </style>
</head>
<body>
  <div id="app">
    <div id="feed"></div>
    <button id="more" class="more">–ï—â—ë</button>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  tg?.ready?.();
  tg?.expand?.();

  const API_BASE = "https://YOUR_BACKEND_DOMAIN"; // <-- —Å—é–¥–∞ –¥–æ–º–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞ (https)

  const feedEl = document.getElementById("feed");
  const moreBtn = document.getElementById("more");
  let cursor = null;

  moreBtn.onclick = () => loadMore();
  loadMore();

  async function loadMore() {
    try {
      const url = cursor ? `${API_BASE}/feed?cursor=${cursor}` : `${API_BASE}/feed`;
      const r = await fetch(url);
      if (!r.ok) throw new Error(await r.text());
      const posts = await r.json();

      if (!posts.length && !cursor) {
        feedEl.innerHTML = `<div class="hint">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç –±–æ—Ç—É —á–µ—Ä–µ–∑ <b>/newpost</b>.</div>`;
        moreBtn.style.display = "none";
        return;
      }
      if (!posts.length) {
        moreBtn.style.display = "none";
        return;
      }

      posts.forEach(renderPost);
      cursor = posts[posts.length - 1].id;
    } catch (e) {
      feedEl.innerHTML = `<div class="hint">–ù–µ –º–æ–≥—É –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–µ–Ω—Ç—É. –ü—Ä–æ–≤–µ—Ä—å API_BASE –∏ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS.</div>`;
      moreBtn.style.display = "none";
    }
  }

  function renderPost(p) {
    const r = p.reactions || {};
    const el = document.createElement("div");
    el.className = "post";
    el.innerHTML = `
      <div class="text">${escapeHtml(p.text)}</div>
      <div class="reactions">
        <button class="reaction" data-t="support">ü§ç <span>${r.support ?? 0}</span></button>
        <button class="reaction" data-t="hug">ü´Ç <span>${r.hug ?? 0}</span></button>
        <button class="reaction" data-t="sad">üòî <span>${r.sad ?? 0}</span></button>
      </div>
    `;

    el.querySelectorAll(".reaction").forEach(btn => {
      btn.onclick = async () => {
        const type = btn.dataset.t;
        await fetch(`${API_BASE}/posts/${p.id}/react`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ type })
        });
        const span = btn.querySelector("span");
        span.textContent = String((Number(span.textContent) || 0) + 1);
      };
    });

    feedEl.appendChild(el);
  }

  function escapeHtml(text) {
    return String(text).replace(/[&<>"']/g, m =>
      ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[m])
    );
  }
</script>
</body>
</html>
